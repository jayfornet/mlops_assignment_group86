name: Simple Data Monitoring Pipeline - Scheduled Only

# This version only uses scheduled monitoring, no webhooks required

on:
  schedule:
    # Check for data changes every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual triggers
    inputs:
      force_retrain:
        description: 'Force model retraining even if data unchanged'
        type: boolean
        required: false
        default: false

permissions:
  contents: write
  actions: write

env:
  PYTHON_VERSION: 3.9

jobs:
  # Simple data monitoring without external triggers
  monitor-and-trigger:
    runs-on: ubuntu-latest
    name: Monitor Data and Trigger Pipeline
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn requests
        
    - name: Check for data changes
      id: check_changes
      run: |
        python scripts/data_monitoring.py --validate-only
        
        # If data changed, trigger MLOps pipeline
        if [ $? -eq 0 ]; then
          echo "data_changed=true" >> $GITHUB_OUTPUT
        else
          echo "data_changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Trigger MLOps Pipeline
      if: steps.check_changes.outputs.data_changed == 'true' || github.event.inputs.force_retrain == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'mlops-pipeline.yml',
            ref: 'main',
            inputs: {
              'triggered_by': 'scheduled-monitoring',
              'trigger_reason': 'Scheduled data check detected changes'
            }
          });
